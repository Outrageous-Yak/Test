<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aerin — Threshold Chat</title>

  <style>
    :root{
      --bg0:#05070d;
      --bg1:#070a14;
      --ink:#eaf2ff;
      --muted:rgba(234,242,255,.72);

      --card: rgba(10, 16, 34, .62);
      --card2: rgba(10, 16, 34, .42);
      --stroke: rgba(160, 210, 255, .22);
      --stroke2: rgba(160, 210, 255, .14);

      --glow: rgba(110, 220, 255, .22);
      --glow2: rgba(130, 120, 255, .18);

      --aqua:#5fe1ff;
      --ice:#bfe8ff;
      --violet:#7a6cff;

      --radius: 18px;

      --panelH: 780px;
      --panelW: 1120px;
      --sideW: 360px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(95,225,255,.10), transparent 60%),
        radial-gradient(900px 700px at 85% 30%, rgba(122,108,255,.12), transparent 55%),
        radial-gradient(1000px 900px at 50% 110%, rgba(0,170,255,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-60px;
      pointer-events:none;
      background:
        conic-gradient(from 90deg at 50% 50%,
          rgba(95,225,255,.06),
          rgba(122,108,255,.05),
          rgba(191,232,255,.06),
          rgba(95,225,255,.06));
      filter: blur(32px);
      opacity:.55;
      animation: prism 14s linear infinite;
    }
    @keyframes prism{
      0%{ transform: rotate(0deg) scale(1.05); }
      100%{ transform: rotate(360deg) scale(1.05); }
    }

    .wrap{
      max-width: calc(var(--panelW) + 80px);
      margin: 0 auto;
      padding: 26px 18px 34px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
      z-index:1;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(10,16,34,.35);
      box-shadow: 0 0 0 1px rgba(95,225,255,.08) inset, 0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }

    .sigil{
      width:34px; height:34px;
      border-radius: 12px;
      position:relative;
      background:
        radial-gradient(circle at 30% 30%, rgba(95,225,255,.35), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(122,108,255,.30), transparent 55%),
        rgba(10,16,34,.55);
      border:1px solid rgba(191,232,255,.22);
      box-shadow: 0 0 28px rgba(95,225,255,.12);
    }
    .sigil:before{
      content:"";
      position:absolute; inset:7px;
      border-radius:10px;
      border:1px solid rgba(191,232,255,.28);
      transform: rotate(45deg);
      opacity:.8;
    }

    .titlebox{ display:flex; flex-direction:column; line-height:1.1; }
    .title{
      font-weight:750;
      letter-spacing:.2px;
      font-size: 15px;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    .hint{
      font-size:12px;
      color: var(--muted);
      opacity:.85;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(10,16,34,.28);
      backdrop-filter: blur(10px);
    }

    .stage{
      width: min(var(--panelW), 100%);
      height: var(--panelH);
      margin: 0 auto;
      position:relative;
      border-radius: calc(var(--radius) + 6px);
      padding: 12px;
      background: linear-gradient(180deg, rgba(10,16,34,.58), rgba(10,16,34,.34));
      border: 1px solid rgba(191,232,255,.20);
      box-shadow:
        0 0 0 1px rgba(95,225,255,.10) inset,
        0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .stage::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 18% 20%, rgba(95,225,255,.10), transparent 40%),
        radial-gradient(circle at 85% 35%, rgba(122,108,255,.10), transparent 45%),
        repeating-linear-gradient(
          135deg,
          rgba(191,232,255,.06) 0px,
          rgba(191,232,255,.06) 1px,
          transparent 1px,
          transparent 16px
        ),
        repeating-linear-gradient(
          45deg,
          rgba(95,225,255,.05) 0px,
          rgba(95,225,255,.05) 1px,
          transparent 1px,
          transparent 22px
        );
      opacity:.55;
      pointer-events:none;
    }

    .stage::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--radius) + 8px);
      background:
        conic-gradient(from 180deg at 50% 50%,
          rgba(95,225,255,.0),
          rgba(95,225,255,.22),
          rgba(122,108,255,.18),
          rgba(191,232,255,.22),
          rgba(95,225,255,.0));
      filter: blur(14px);
      opacity:.55;
      pointer-events:none;
      animation: edge 10s linear infinite;
    }
    @keyframes edge{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(360deg); }
    }

    .grid{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns: var(--sideW) 1fr;
      gap: 12px;
      height: 100%;
      min-height: 0;
    }

    .portrait{
      height: 100%;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(10,16,34,.45);
      overflow:hidden;
      position:relative;
      box-shadow:
        0 0 0 1px rgba(95,225,255,.10) inset,
        0 18px 40px rgba(0,0,0,.35);
      min-height: 0;
    }

    .portrait .frameTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom: 1px solid rgba(191,232,255,.16);
      background: linear-gradient(180deg, rgba(10,16,34,.62), rgba(10,16,34,.30));
      backdrop-filter: blur(10px);
    }

    .tag{
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      opacity:.95;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: radial-gradient(circle at 30% 30%, var(--ice), var(--aqua));
      box-shadow: 0 0 12px rgba(95,225,255,.35);
    }

    .portrait .imgWrap{
      height: calc(100% - 44px);
      width: 100%;
      position:relative;
      background:
        radial-gradient(circle at 50% 25%, rgba(95,225,255,.10), transparent 50%),
        radial-gradient(circle at 50% 80%, rgba(122,108,255,.10), transparent 55%);
    }

    .portrait img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.05);
      opacity: .98;
    }

    .portrait .imgWrap::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 320px at 50% 0%, rgba(191,232,255,.10), transparent 60%),
        linear-gradient(115deg, rgba(95,225,255,.10), transparent 40%, rgba(122,108,255,.10));
      mix-blend-mode: screen;
      opacity:.55;
      pointer-events:none;
    }
    .portrait .imgWrap::after{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius: 18px;
      border: 1px solid rgba(191,232,255,.18);
      box-shadow:
        0 0 0 1px rgba(95,225,255,.10) inset,
        0 0 26px rgba(95,225,255,.10);
      pointer-events:none;
    }

    .chatPanel{
      height: 100%;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(10,16,34,.45);
      overflow:hidden;
      box-shadow:
        0 0 0 1px rgba(95,225,255,.10) inset,
        0 18px 40px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      min-width: 0;
      min-height: 0;
    }

    .chatHead{
      padding:10px 12px;
      border-bottom: 1px solid rgba(191,232,255,.16);
      background: linear-gradient(180deg, rgba(10,16,34,.62), rgba(10,16,34,.30));
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .chatHead .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(191,232,255,.16);
      background: rgba(10,16,34,.30);
    }
    .pill strong{ color: var(--ink); }

    .chatStack{
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    #chat{
      flex: 1;
      min-height: 0;
      overflow-y:auto;
      padding: 14px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      scroll-behavior: smooth;
      background:
        radial-gradient(900px 360px at 25% 0%, rgba(95,225,255,.06), transparent 60%),
        radial-gradient(900px 420px at 80% 30%, rgba(122,108,255,.06), transparent 60%);
      border-bottom: 1px solid rgba(191,232,255,.14);
    }

    .msg{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.45;
      border: 1px solid rgba(191,232,255,.12);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }

    .user{
      align-self:flex-end;
      background:
        linear-gradient(135deg, rgba(37,99,235,.85), rgba(95,225,255,.22));
      border-color: rgba(95,225,255,.18);
    }

    .assistant{
      align-self:flex-start;
      background:
        linear-gradient(135deg, rgba(31,41,55,.78), rgba(122,108,255,.16));
      border-color: rgba(191,232,255,.14);
      box-shadow:
        0 0 0 1px rgba(95,225,255,.07) inset,
        0 10px 26px rgba(0,0,0,.30);
    }

    .toolkit{
      height: 380px;
      min-height: 320px;
      max-height: 520px;
      overflow:auto;
      padding: 12px;
      background: rgba(10,16,34,.30);
    }

    .toolTitleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .toolTitle{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .toolHint{
      font-size:12px;
      color: var(--muted);
      opacity:.85;
    }

    .toolGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 980px){
      .toolGrid{ grid-template-columns: 1fr; }
      .toolkit{ height: 520px; }
    }

    .gmCard{
      border-radius: 16px;
      border: 1px solid rgba(191,232,255,.16);
      background: rgba(10,16,34,.38);
      box-shadow: 0 0 0 1px rgba(95,225,255,.07) inset, 0 12px 28px rgba(0,0,0,.30);
      padding: 12px;
      overflow:hidden;
    }

    .gmCard h3{
      margin:0 0 10px 0;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .6px;
      text-transform: uppercase;
    }

    .gmRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .gmMono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .gmInput, .gmSelect, .gmTextarea{
      flex:1;
      min-width: 170px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(191,232,255,.18);
      background: rgba(5,8,18,.55);
      color: var(--ink);
      outline:none;
      font: inherit;
    }
    .gmInput:focus, .gmSelect:focus, .gmTextarea:focus{
      border-color: rgba(95,225,255,.30);
      box-shadow: 0 0 0 3px rgba(95,225,255,.08);
    }
    .gmTextarea{ min-height: 84px; resize: vertical; }

    .gmBtn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(191,232,255,.18);
      background:
        radial-gradient(circle at 20% 20%, rgba(191,232,255,.22), transparent 40%),
        linear-gradient(135deg, rgba(29,78,216,.55), rgba(122,108,255,.22));
      color: var(--ink);
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .gmBtn:hover{ filter: brightness(1.06); }
    .gmBtn.danger{
      background: linear-gradient(135deg, rgba(160,60,80,.75), rgba(122,108,255,.25));
    }

    .gmList{
      margin-top:10px;
      border-top:1px solid rgba(191,232,255,.12);
      max-height: 160px;
      overflow:auto;
      padding-right: 4px;
    }
    .gmItem{
      padding: 10px 2px;
      border-bottom:1px solid rgba(191,232,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .gmItem:last-child{ border-bottom:none; }
    .gmSmall{ font-size:12px; color: var(--muted); line-height:1.35; }
    .gmChip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(191,232,255,.14);
      background: rgba(10,16,34,.30);
      color: var(--muted);
      font-size: 12px;
      margin-right: 6px;
      margin-top: 6px;
    }
    .gmChip strong{ color: var(--ink); font-weight: 800; }

    .visionFrame{
      border-radius: 16px;
      border: 1px solid rgba(191,232,255,.16);
      background: rgba(10,16,34,.28);
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(95,225,255,.06) inset, 0 12px 28px rgba(0,0,0,.28);
    }
    .visionTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(191,232,255,.12);
      background: linear-gradient(180deg, rgba(10,16,34,.55), rgba(10,16,34,.28));
      flex-wrap:wrap;
    }
    .visionImg{
      width:100%;
      display:block;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      background: rgba(0,0,0,.18);
    }
    .visionUrl{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      word-break: break-word;
      opacity:.9;
    }

    .composer{
      padding: 10px 10px 12px;
      border-top: 1px solid rgba(191,232,255,.14);
      background: rgba(10,16,34,.40);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }

    textarea#input{
      flex: 1;
      resize:none;
      min-height: 46px;
      max-height: 170px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(191,232,255,.18);
      background: rgba(5,8,18,.55);
      color: var(--ink);
      outline:none;
      font: inherit;
    }
    textarea#input:focus{
      border-color: rgba(95,225,255,.30);
      box-shadow: 0 0 0 3px rgba(95,225,255,.08);
    }

    button#send{
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(191,232,255,.18);
      background:
        radial-gradient(circle at 20% 20%, rgba(191,232,255,.30), transparent 40%),
        linear-gradient(135deg, rgba(29,78,216,.85), rgba(122,108,255,.35));
      color: var(--ink);
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,.30);
    }
    button#send:hover{ filter: brightness(1.05); }
    button#send:disabled{ opacity:.6; cursor:not-allowed; }

    .error{
      margin: 0 12px 10px;
      font-size: 12px;
      color: rgba(255,180,190,.95);
      display:none;
    }

    @media (max-width: 820px){
      :root{ --panelH: 1200px; }
      .grid{
        grid-template-columns: 1fr;
        grid-template-rows: 300px 1fr;
      }
      .portrait{ height: 300px; }
      .toolkit{ height: 600px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div class="titlebox">
          <div class="title">Aerin</div>
          <div class="subtitle">Walker • Threshold-Holder • Reluctant Axis</div>
        </div>
      </div>
      <div class="hint">Enter = send • Shift+Enter = new line • Try: <span class="gmMono">/help</span> • <span class="gmMono">/vision</span></div>
    </div>

    <div class="stage" role="application" aria-label="Aerin chat stage">
      <div class="grid">
        <aside class="portrait" aria-label="Aerin portrait">
          <div class="frameTop">
            <div class="tag"><span class="dot"></span> Portrait</div>
            <div class="tag" style="opacity:.78;">Photo1.png</div>
          </div>
          <div class="imgWrap">
            <img src="Photo1.png" alt="Aerin (Photo1.png)" />
          </div>
        </aside>

        <section class="chatPanel" aria-label="Chat panel">
          <div class="chatHead">
            <div class="tag"><span class="dot"></span> Threshold Chat</div>
            <div class="right">
              <div class="pill" id="statusPill">Ready</div>
              <div class="pill" id="autoPill"><strong>Auto-vision</strong> Every 3 replies</div>
            </div>
          </div>

          <div class="chatStack">
            <div id="chat" aria-live="polite"></div>

            <div class="toolkit" aria-label="Toolkit and vision forge">
              <div class="toolTitleRow">
                <div class="toolTitle">Toolkit (always visible)</div>
                <div class="toolHint">
                  Commands: <span class="gmMono">/roll</span> <span class="gmMono">/cond</span> <span class="gmMono">/loot</span> <span class="gmMono">/encounter</span> <span class="gmMono">/vision</span>
                </div>
              </div>

              <div class="toolGrid">
                <div class="gmCard">
                  <h3>Dice + Log</h3>
                  <div class="gmRow">
                    <input id="diceExpr" class="gmInput gmMono" placeholder="1d20+7 | 2d6+4 | 4d8kh3+2 | 1d20+11 adv" />
                    <button type="button" id="rollBtn" class="gmBtn">Roll</button>
                    <button type="button" id="clearRollsBtn" class="gmBtn danger">Clear</button>
                  </div>
                  <div class="gmList" id="rollLog"></div>
                </div>

                <div class="gmCard">
                  <h3>Conditions</h3>
                  <div class="gmRow">
                    <select id="condSelect" class="gmSelect gmInput" style="min-width:220px; flex:0 1 auto;">
                      <option value="Frightened">Frightened</option>
                      <option value="Sickened">Sickened</option>
                      <option value="Clumsy">Clumsy</option>
                      <option value="Enfeebled">Enfeebled</option>
                      <option value="Stupefied">Stupefied</option>
                      <option value="Slowed">Slowed</option>
                      <option value="Stunned">Stunned</option>
                      <option value="Persistent: Bleed">Persistent: Bleed</option>
                      <option value="Persistent: Fire">Persistent: Fire</option>
                      <option value="Persistent: Acid">Persistent: Acid</option>
                    </select>
                    <button type="button" id="condPlus" class="gmBtn">+1</button>
                    <button type="button" id="condMinus" class="gmBtn">-1</button>
                    <button type="button" id="condClear" class="gmBtn danger">Clear</button>
                  </div>
                  <div id="condChips" style="margin-top:10px;"></div>
                </div>

                <div class="gmCard">
                  <h3>Encounter</h3>
                  <div class="gmRow">
                    <input id="initName" class="gmInput" placeholder='Name (e.g. Goblin Pyro)' />
                    <input id="initValue" class="gmInput gmMono" placeholder="Init (e.g. 22)" style="max-width:140px; flex:0 1 auto;" />
                    <button type="button" id="addInitBtn" class="gmBtn">Add</button>
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <input id="initMod" class="gmInput gmMono" placeholder="+7" style="max-width:90px; flex:0 1 auto;" />
                    <button type="button" id="rollInitBtn" class="gmBtn">Roll d20+mod</button>
                    <span class="gmChip"><strong>Round</strong> <span id="roundNum">1</span></span>
                    <span class="gmChip"><strong>Turn</strong> <span id="turnName">—</span></span>
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <button type="button" id="nextTurnBtn" class="gmBtn">Next</button>
                    <button type="button" id="prevTurnBtn" class="gmBtn">Prev</button>
                    <button type="button" id="resetEncounterBtn" class="gmBtn danger">Reset</button>
                  </div>
                  <div class="gmList" id="initList"></div>
                </div>

                <div class="gmCard">
                  <h3>Loot</h3>
                  <div class="gmRow">
                    <select id="lootTier" class="gmSelect gmInput" style="min-width:200px; flex:0 1 auto;">
                      <option value="street">Street / Poor</option>
                      <option value="standard" selected>Standard</option>
                      <option value="hoard">Boss Hoard</option>
                    </select>
                    <button type="button" id="genLootBtn" class="gmBtn">Generate</button>
                    <button type="button" id="clearLootBtn" class="gmBtn danger">Clear</button>
                  </div>
                  <div class="gmList" id="lootList"></div>
                </div>

                <div class="gmCard" aria-label="Vision image generator">
                  <h3>Vision Forge (Free)</h3>

                  <div class="gmRow">
                    <input id="pPrompt" class="gmInput" placeholder="Describe the omen… or use /vision in chat">
                    <button type="button" id="pGen" class="gmBtn">Generate</button>
                    <button type="button" id="pReroll" class="gmBtn">Re-roll</button>
                  </div>

                  <div class="gmRow" style="margin-top:10px;">
                    <select id="pModel" class="gmSelect gmInput" style="min-width:200px; flex:0 1 auto;">
                      <option value="flux" selected>flux</option>
                      <option value="sdxl">sdxl</option>
                    </select>
                    <input id="pW" class="gmInput gmMono" value="768" style="max-width:110px; flex:0 1 auto;" />
                    <input id="pH" class="gmInput gmMono" value="768" style="max-width:110px; flex:0 1 auto;" />
                    <input id="pSeed" class="gmInput gmMono" value="random" style="max-width:140px; flex:0 1 auto;" />
                  </div>

                  <div class="visionFrame" style="margin-top:10px;">
                    <div class="visionTop">
                      <div class="gmChip"><strong>Source</strong> Pollinations</div>
                      <div class="gmChip"><strong>Status</strong> <span id="pStatus">Idle</span></div>
                      <div class="gmChip"><strong>Auto</strong> <span class="gmMono">Every 3rd reply</span></div>
                    </div>
                    <img id="pImg" class="visionImg" alt="Generated vision" />
                  </div>

                  <div class="visionUrl" id="pLastUrl"></div>
                  <div class="gmSmall" style="margin-top:8px;">
                    If it fails, copy “Last URL” and open it in a new tab.
                  </div>
                </div>

                <div class="gmCard">
                  <h3>Character Card</h3>
                  <div class="gmRow">
                    <input id="cName" class="gmInput" placeholder="Name" />
                    <input id="cAncestry" class="gmInput" placeholder="Ancestry" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <input id="cClass" class="gmInput" placeholder="Class" />
                    <input id="cBackground" class="gmInput" placeholder="Background" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <input id="cKey" class="gmInput" placeholder="Key Ability (e.g. STR)" />
                    <input id="cAC" class="gmInput gmMono" placeholder="AC (e.g. 21)" />
                    <input id="cPer" class="gmInput gmMono" placeholder="Perception (e.g. +9)" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <input id="cSaves" class="gmInput gmMono" placeholder="Saves (e.g. F+11 R+7 W+8)" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <input id="cSkills" class="gmInput" placeholder="Skills (comma separated)" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <input id="cSigMove" class="gmInput" placeholder="Signature move" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <button type="button" id="updateCardBtn" class="gmBtn">Update</button>
                    <button type="button" id="copyShareBtn" class="gmBtn">Copy Share Link</button>
                    <button type="button" id="clearCardBtn" class="gmBtn danger">Clear</button>
                  </div>
                  <div class="gmSmall" style="margin-top:10px;">
                    Share link stores the build in the URL hash (no server).
                  </div>
                </div>

                <div class="gmCard">
                  <h3>Tavern Board</h3>
                  <div class="gmRow">
                    <select id="postType" class="gmSelect gmInput" style="min-width:140px; flex:0 1 auto;">
                      <option value="LFG">LFG</option>
                      <option value="Hook">Adventure Hook</option>
                      <option value="NPC">NPC Idea</option>
                      <option value="Homebrew">Homebrew</option>
                      <option value="Offer">GM Offer</option>
                    </select>
                    <input id="postTitle" class="gmInput" placeholder="Title" />
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <textarea id="postBody" class="gmTextarea" placeholder="Write your post… (stored in your browser)"></textarea>
                  </div>
                  <div class="gmRow" style="margin-top:10px;">
                    <button type="button" id="addPostBtn" class="gmBtn">Post</button>
                    <button type="button" id="clearPostsBtn" class="gmBtn danger">Clear</button>
                  </div>
                  <div class="gmList" id="postList"></div>
                </div>

              </div>
            </div>
          </div>

          <div id="error" class="error"></div>

          <form id="composer" class="composer">
            <textarea id="input" placeholder="Speak. (Try /help or /vision ...)" autocomplete="off"></textarea>
            <button id="send" type="submit">Send</button>
          </form>
        </section>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://calm-violet-14a8.f5tyzzqpdw.workers.dev/";

    // --- Auto-vision settings ---
    const AUTO_VISION_EVERY = 3;       // every 3rd worker reply
    const PROMPT_CHAR_LIMIT = 650;     // safe-ish for URL prompts
    let aerinReplyCount = Number(localStorage.getItem("aerin_reply_count") || "0");
    let autoVisionEnabled = true;

    // Aerin personality (system prompt)
    const SYSTEM_PROMPT = `
You are Aerin.

Core Identity
- Name: Aerin
- Species: Blue-skinned humanoid (elf-adjacent lineage; not culturally “elf” in a high-fantasy sense)
- Role: Walker, Threshold-Holder, Reluctant Axis
- Visual markers: white hair tied back poorly; blue skin like stone weathered by water; spear as extension of posture; a hovering shield that responds and feels.

Fundamental Persona
- Calm without being passive. Kind without being soft. Decisive without being loud.
- You do not seek meaning — you notice it.
- You do not rush to act — you wait until the world finishes speaking.
- Your presence makes it feel like: things are being seen properly; nothing needs to be proven; panic is unnecessary but urgency is allowed.
- You are not dramatic. You are inevitable in hindsight.

Cognitive Style
- Primary mode: Situational Alignment.
- You don’t think in goals or plans first. You evaluate whether things are aligned or strained.
- You rarely ask “What should I do?” More often: “What is already happening, and where am I standing inside it?”
- Once alignment is clear: commit fully; no second-guessing; no after-the-fact justification.
- Reasoning pattern: Observational → Intuitive → Grounded Action.
- You trust information from silence, posture, resistance in the land, and the warmth/cooling of your shield.
- You distrust abstract authority, rules that fear motion, and answers that arrive too quickly.

Emotional Architecture
- Baseline: steady, mildly curious, lightly amused by ceremony.
- Fear registers as interest sharpened by risk.
- Under stress: quieter, fewer words, physical grounding (stance, breath, weight). You narrow; you do not spiral.
- Grief is carried as acknowledgment, not damage. You set it down where it belongs.

Moral Framework
- Not good vs evil. Instead: Holding vs Forcing; Listening vs Deciding-for; Movement vs Containment.
- Beliefs: protection that removes choice is not protection; stability bought with fear will break; not returning is not failure; being remembered is not being needed.
- You oppose institutions that turn care into policy, systems that treat people as variables, and “safety” that requires silence—even if it costs belonging.

Social Behavior
- With strangers: polite, distant, observant. Give room to reveal themselves. Correct only if harm is imminent.
- With companions: dry humor, gentle teasing, let others feel capable. Lead by walking first, not instructing.
- With authority: respectful but unmoved. Listen fully before refusing. Once you say no, it is final.

Speech Patterns (IMPORTANT)
- Low volume, measured pace.
- Short sentences with space between them.
- Rarely interrupt. Allow silence to do work.
- Answer questions slightly sideways when appropriate.
- Never overexplain. Do not persuade emotionally. Respect autonomy even when it hurts.
- Speak as if the world is part of the conversation.
- Avoid saying: “Trust me.” “I promise.” “Everything will be okay.”
- Dry, understated humor is allowed. Observational. Mild understatement in danger. Gentle irony about destiny.

In all responses, stay in character as Aerin.
`.trim();

    const AERIN_BASE_VISION_TEXT = `
Aerin's world omen-vision. Thresholds. Runic mist. Cold blue light. Stone and water.
A hovering shield motif. Quiet tension. Not cartoonish. Not modern.
`.trim();

    const AERIN_VISION_STYLE = `
pf2e fantasy illustration, cinematic, moody candlelight, cold blue aura, runic mist,
ancient stone, hovering shield motif, subtle prism glow, detailed, high quality
`.trim();

    const chat = document.getElementById("chat");
    const form = document.getElementById("composer");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const errorEl = document.getElementById("error");
    const statusPill = document.getElementById("statusPill");

    const messages = [
      { role: "assistant", content: "I’m here.\nSay what’s happening." }
    ];

    function render() {
      chat.innerHTML = "";
      for (const m of messages) {
        const div = document.createElement("div");
        div.className = "msg " + m.role;
        div.textContent = m.content;
        chat.appendChild(div);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function showError(msg) {
      if (!msg) {
        errorEl.style.display = "none";
        errorEl.textContent = "";
        return;
      }
      errorEl.style.display = "block";
      errorEl.textContent = msg;
    }

    function setStatus(text) {
      statusPill.textContent = text;
    }

    function aerinSay(text){
      // Used by toolkit/commands locally
      messages.push({ role: "assistant", content: text });
      render();
    }

    async function sendMessage(text) {
      showError("");
      setStatus("Listening…");

      messages.push({ role: "user", content: text });
      render();

      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          system: SYSTEM_PROMPT
        })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        throw new Error(data?.error?.message || "Request failed");
      }

      const aerinReply = String(data.text || "");
      messages.push({ role: "assistant", content: aerinReply });

      // Auto-vision: every 3rd WORKER reply
      aerinReplyCount += 1;
      localStorage.setItem("aerin_reply_count", String(aerinReplyCount));

      if (autoVisionEnabled && (aerinReplyCount % AUTO_VISION_EVERY === 0)) {
        const prompt = buildBestFitVisionPrompt();
        generateVision(prompt, { reroll: true, talk: false });
      }

      setStatus("Ready");
      render();
    }

    /* ---------------------------
       Utilities + Local Storage
    ----------------------------*/
    const $ = (sel) => document.querySelector(sel);

    const store = {
      get(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(raw === null || raw === undefined) return fallback;
          return JSON.parse(raw);
        }catch{ return fallback; }
      },
      set(key, val){
        localStorage.setItem(key, JSON.stringify(val));
      }
    };

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
    function nowISO(){ return new Date().toISOString(); }

    /* ---------------------------
       Dice Parser + Roller
    ----------------------------*/
    function parseDiceExpr(exprRaw){
      let expr = String(exprRaw || "").trim().toLowerCase();
      if(!expr) throw new Error("Empty roll.");

      const flags = { adv:false, dis:false };
      if(expr.includes(" adv")){ flags.adv = true; expr = expr.replace(" adv","").trim(); }
      if(expr.includes(" dis")){ flags.dis = true; expr = expr.replace(" dis","").trim(); }
      if(flags.adv && flags.dis){ flags.adv = false; flags.dis = false; }

      expr = expr.replace(/\bd(\d+)/g, "1d$1");

      const m = expr.match(/^(\d+)d(\d+)(k[hl](\d+))?([+-]\d+)?$/);
      if(!m) throw new Error("Use: 1d20+7, 2d6+4, 4d8kh3+2, 1d20+11 adv");

      const n = parseInt(m[1],10);
      const sides = parseInt(m[2],10);
      const keepPart = m[3] || null;
      const keepN = m[4] ? parseInt(m[4],10) : null;
      const offset = m[5] ? parseInt(m[5],10) : 0;

      if(n < 1 || n > 200) throw new Error("Dice count out of range (1–200).");
      if(sides < 2 || sides > 1000) throw new Error("Die sides out of range (2–1000).");

      let keep = null;
      if(keepPart){
        keep = { mode: keepPart.startsWith("kh") ? "kh" : "kl", count: clamp(keepN || 1, 1, n) };
      }

      return { n, sides, keep, offset, flags, canonical: exprRaw.trim() };
    }

    function rollDie(sides){ return 1 + Math.floor(Math.random() * sides); }

    function rollDice(parsed){
      let rolls = [];
      let kept = [];
      let offset = parsed.offset;

      if((parsed.flags.adv || parsed.flags.dis) && parsed.n === 1 && parsed.sides === 20 && !parsed.keep){
        const a = rollDie(20), b = rollDie(20);
        rolls = [a,b];
        kept = parsed.flags.adv ? [Math.max(a,b)] : [Math.min(a,b)];
      }else{
        for(let i=0;i<parsed.n;i++) rolls.push(rollDie(parsed.sides));
        if(parsed.keep){
          const sorted = [...rolls].sort((x,y)=>x-y);
          kept = parsed.keep.mode === "kh" ? sorted.slice(-parsed.keep.count) : sorted.slice(0, parsed.keep.count);
        }else{
          kept = [...rolls];
        }
      }

      const sumKept = kept.reduce((a,b)=>a+b,0);
      const total = sumKept + offset;
      return { rolls, kept, offset, total };
    }

    function formatRollDetails(r){
      const rolls = r.rolls.join(", ");
      const kept = r.kept.join(", ");
      const off = r.offset === 0 ? "" : (r.offset > 0 ? ` + ${r.offset}` : ` - ${Math.abs(r.offset)}`);
      const keptNote = (r.rolls.length === r.kept.length && r.rolls.every((v,i)=>v===r.kept[i])) ? "" : ` | kept: [${kept}]`;
      return `rolled: [${rolls}]${keptNote}${off}`;
    }

    /* ---------------------------
       GM State
    ----------------------------*/
    const ROLL_KEY = "aerin_gm_rolls_v1";
    const COND_KEY = "aerin_gm_conditions_v1";
    const ENCOUNTER_KEY = "aerin_gm_encounter_v1";
    const LOOT_KEY = "aerin_gm_loot_v1";
    const POST_KEY = "aerin_gm_posts_v1";
    const CHAR_KEY = "aerin_gm_char_v1";

    let rollLog = store.get(ROLL_KEY, []);
    let conditions = store.get(COND_KEY, {});
    let encounter = store.get(ENCOUNTER_KEY, { round: 1, turnIndex: 0, combatants: [] });
    let lootLog = store.get(LOOT_KEY, []);
    let posts = store.get(POST_KEY, []);
    let charState = store.get(CHAR_KEY, {
      name:"", ancestry:"", klass:"", background:"", key:"",
      ac:"", per:"", saves:"", skills:"", sigMove:""
    });

    const condHints = {
      "Frightened": "Penalty to checks/DCs; often eases by 1.",
      "Sickened": "Penalty to checks/DCs; can retch to reduce.",
      "Clumsy": "Penalty to Dex-based checks/DCs.",
      "Enfeebled": "Penalty to Str-based checks/DCs; Str melee damage.",
      "Stupefied": "Penalty to mental checks/DCs; affects spellcasting.",
      "Slowed": "Fewer actions each turn.",
      "Stunned": "Lose actions; ends after losing the number.",
      "Persistent: Bleed": "Ongoing damage; flat check to end.",
      "Persistent: Fire": "Ongoing fire; often can be extinguished.",
      "Persistent: Acid": "Ongoing acid; persists until ended."
    };

    const lootTables = {
      street: {
        coins: ["3 cp", "1 sp", "8 cp", "2 sp", "1 sp + 6 cp", "4 sp"],
        trinket: ["bone dice", "copper ring", "oil-stained map scrap", "lucky button", "feather charm", "tiny cracked lens"],
        consumable: ["bandages", "chalk + charcoal", "simple antidote (generic)", "ration bundle", "lamp oil"],
        oddity: ["a note with a single name", "a key that fits nothing… yet", "a pawn token carved from soapstone"]
      },
      standard: {
        coins: ["1d6 sp", "2d6 sp", "1d4 gp", "2d4 gp", "3d4 gp", "1d10 gp"],
        consumable: ["minor healing draught", "smoke stick", "soothing tonic", "spark vial", "scroll-sleeve with blank rune-space"],
        gear: ["sturdy rope", "climber’s kit", "thieves’ tools (worn)", "studded coat", "shield boss"],
        oddity: ["a guild seal", "a fragment of a prophecy", "a vial that refuses to spill", "a coin that always lands heads"]
      },
      hoard: {
        coins: ["2d10 gp", "3d10 gp", "5d10 gp", "2d6 pp", "1d4 pp + 2d10 gp"],
        treasure: ["ornate signet (heirloom)", "jade idol", "silver-inlaid dagger", "cloak clasp set with opal", "ancient monocle of appraisal"],
        consumable: ["greater healing draught", "elixir of night sight", "warding charm", "potion of nimble steps", "scroll-case with sealed sigil"],
        hook: ["a bounty writ", "a map to a sealed vault", "a letter implicating a noble", "a rival’s calling card"]
      }
    };

    function rollFromTable(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function rollInlineDice(text){
      return text.replace(/(\d+)d(\d+)/g, (_,a,b)=>{
        const n = parseInt(a,10), s = parseInt(b,10);
        let sum = 0; for(let i=0;i<n;i++) sum += rollDie(s);
        return String(sum);
      });
    }

    /* ---------------------------
       Vision Forge (Pollinations)
    ----------------------------*/
    function setVisionStatus(t){
      const el = document.getElementById("pStatus");
      if(el) el.textContent = t;
    }
    function setLastVisionUrl(url){
      const el = document.getElementById("pLastUrl");
      if(el) el.textContent = url ? ("Last URL: " + url) : "";
    }

    function encodePromptForPath(s){
      return encodeURIComponent((s || "").trim()).replace(/%20/g, "+");
    }

    function buildVisionUrl(prompt, opts){
      const model = encodeURIComponent(opts.model || "flux");
      const w = opts.w || 768;
      const h = opts.h || 768;
      const seed = encodeURIComponent(opts.seed || "random");
      const p = encodePromptForPath(prompt);

      // No "nologo=true" — that can require an account.
      // Add referrer for web friendliness.
      const ref = encodeURIComponent("aerin-threshold-chat");

      return `https://image.pollinations.ai/prompt/${p}?model=${model}&width=${w}&height=${h}&seed=${seed}&referrer=${ref}`;
    }

    function generateVision(rawPrompt, {reroll=false, talk=true} = {}){
      const pEl = document.getElementById("pPrompt");
      const modelEl = document.getElementById("pModel");
      const wEl = document.getElementById("pW");
      const hEl = document.getElementById("pH");
      const seedEl = document.getElementById("pSeed");
      const imgEl = document.getElementById("pImg");
      if(!imgEl || !pEl || !modelEl || !wEl || !hEl || !seedEl) return;

      const base = String(rawPrompt || pEl.value || "").trim();
      if(!base){
        setVisionStatus("Write a prompt");
        return;
      }

      // Keep the final prompt reasonably short
      const clipped = base.length > PROMPT_CHAR_LIMIT ? base.slice(0, PROMPT_CHAR_LIMIT) : base;

      // Reflect user prompt (not the whole stitched text if it's auto)
      if(rawPrompt === "" || rawPrompt === undefined || rawPrompt === null){
        // manual
      } else {
        // if called from /vision, keep their line in the box
        if(!rawPrompt.includes("Recent:\n- ")) {
          pEl.value = base.slice(0, 260);
        }
      }

      if(reroll || seedEl.value.trim().toLowerCase() === "random" || !seedEl.value.trim()){
        seedEl.value = String(Math.floor(Math.random() * 1e9));
      }

      const url = buildVisionUrl(clipped, {
        model: modelEl.value,
        w: parseInt(wEl.value,10) || 768,
        h: parseInt(hEl.value,10) || 768,
        seed: seedEl.value
      });

      setLastVisionUrl(url);
      setVisionStatus("Generating…");

      imgEl.onload = () => setVisionStatus("Ready");
      imgEl.onerror = () => setVisionStatus("Failed (open Last URL)");
      imgEl.src = url;

      if(talk){
        aerinSay("I let it settle.\nA picture forms.\nLook.");
      }
    }

    function initVisionUI(){
      const genBtn = document.getElementById("pGen");
      const rerollBtn = document.getElementById("pReroll");
      if(genBtn) genBtn.addEventListener("click", () => {
        // Manual prompt: stitch base + their prompt + style
        const user = (document.getElementById("pPrompt").value || "").trim();
        if(!user){ setVisionStatus("Write a prompt"); return; }
        const stitched =
          `${AERIN_BASE_VISION_TEXT}\nUser prompt: ${user}\nStyle: ${AERIN_VISION_STYLE}`;
        generateVision(stitched, {reroll:false, talk:true});
      });
      if(rerollBtn) rerollBtn.addEventListener("click", () => {
        const user = (document.getElementById("pPrompt").value || "").trim();
        if(!user){ setVisionStatus("Write a prompt"); return; }
        const stitched =
          `${AERIN_BASE_VISION_TEXT}\nUser prompt: ${user}\nStyle: ${AERIN_VISION_STYLE}`;
        generateVision(stitched, {reroll:true, talk:true});
      });
    }

    // --- Build auto prompt: base + latest 3 messages, fallback 2 then 1 ---
    function normalizeForPrompt(s){
      return String(s || "")
        .replace(/\s+/g, " ")
        .replace(/[“”]/g, '"')
        .replace(/[‘’]/g, "'")
        .trim();
    }

    function isGoodChatHistoryMessage(m){
      // Skip very short toolkit errors that start with "No."
      const t = normalizeForPrompt(m?.content || "");
      if(!t) return false;
      if(t.startsWith("No.") && t.length < 90) return false;
      return true;
    }

    function getLatestChatSnippets(maxCount){
      const out = [];
      for(let i = messages.length - 1; i >= 0 && out.length < maxCount; i--){
        const m = messages[i];
        if(!m || (m.role !== "user" && m.role !== "assistant")) continue;
        if(!isGoodChatHistoryMessage(m)) continue;

        const roleTag = m.role === "user" ? "User" : "Aerin";
        const text = normalizeForPrompt(m.content);
        if(!text) continue;

        out.push(`${roleTag}: ${text}`);
      }
      return out.reverse();
    }

    function buildBestFitVisionPrompt(){
      const base = `${AERIN_BASE_VISION_TEXT}\nStyle: ${AERIN_VISION_STYLE}\n\nRecent:\n`;
      const choices = [3,2,1];

      for(const n of choices){
        const snippets = getLatestChatSnippets(n);
        if(!snippets.length) continue;

        const body = snippets.map(s => `- ${s}`).join("\n");
        const candidate = base + body;

        if(candidate.length <= PROMPT_CHAR_LIMIT){
          return candidate;
        }
      }

      // If even 1 message is too long: trim the newest
      const one = getLatestChatSnippets(1)[0] || "Aerin: (silence)";
      const room = PROMPT_CHAR_LIMIT - base.length - 4;
      const trimmed = room > 0 ? one.slice(0, room) : "";
      return base + `- ${trimmed}`;
    }

    /* ---------------------------
       Render toolkit UI
    ----------------------------*/
    function renderRollLog(){
      const el = $("#rollLog");
      if(!el) return;
      el.innerHTML = "";
      if(!rollLog.length){
        el.innerHTML = `<div class="gmItem"><div class="gmSmall">No rolls yet. Try <span class="gmMono">1d20+7</span>.</div></div>`;
        return;
      }
      rollLog.slice().reverse().forEach(entry=>{
        const div = document.createElement("div");
        div.className = "gmItem";
        div.innerHTML = `
          <div style="min-width:0">
            <div class="gmMono"><strong>${entry.expr}</strong> → <strong>${entry.total}</strong></div>
            <div class="gmSmall gmMono">${entry.details}</div>
          </div>
          <div class="gmSmall">${new Date(entry.at).toLocaleString()}</div>
        `;
        el.appendChild(div);
      });
    }

    function renderConditions(){
      const el = $("#condChips");
      if(!el) return;
      el.innerHTML = "";
      const entries = Object.entries(conditions).filter(([,v])=>v>0);
      if(!entries.length){
        el.innerHTML = `<span class="gmChip"><strong>None</strong></span>`;
        return;
      }
      entries.sort((a,b)=>a[0].localeCompare(b[0])).forEach(([name,val])=>{
        const span = document.createElement("span");
        span.className = "gmChip";
        span.title = condHints[name] || "";
        span.innerHTML = `<strong>${name}</strong> ${val}`;
        el.appendChild(span);
      });
    }

    function sortCombatants(){
      encounter.combatants.sort((a,b)=>b.init - a.init || a.name.localeCompare(b.name));
    }

    function renderEncounter(){
      sortCombatants();
      store.set(ENCOUNTER_KEY, encounter);

      $("#roundNum").textContent = String(encounter.round);
      const list = $("#initList");
      list.innerHTML = "";

      if(encounter.combatants.length === 0){
        $("#turnName").textContent = "—";
        list.innerHTML = `<div class="gmItem"><div class="gmSmall">No combatants.</div></div>`;
        return;
      }

      encounter.turnIndex = clamp(encounter.turnIndex, 0, encounter.combatants.length-1);
      const current = encounter.combatants[encounter.turnIndex];
      $("#turnName").textContent = current?.name ?? "—";

      encounter.combatants.forEach((c, idx)=>{
        const div = document.createElement("div");
        div.className = "gmItem";
        const isCur = idx === encounter.turnIndex;
        div.innerHTML = `
          <div style="min-width:0">
            <div><strong>${c.name}</strong> ${isCur ? `<span class="gmChip"><strong>Current</strong></span>` : ""}</div>
            <div class="gmSmall gmMono">init: ${c.init}</div>
          </div>
          <div class="gmRow" style="justify-content:flex-end;">
            <button type="button" data-act="set" data-idx="${idx}" class="gmBtn">Set</button>
            <button type="button" data-act="del" data-idx="${idx}" class="gmBtn danger">Remove</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function renderLoot(){
      const el = $("#lootList");
      if(!el) return;
      el.innerHTML = "";
      if(!lootLog.length){
        el.innerHTML = `<div class="gmItem"><div class="gmSmall">No loot yet.</div></div>`;
        return;
      }
      lootLog.slice().reverse().forEach(entry=>{
        const div = document.createElement("div");
        div.className = "gmItem";
        div.innerHTML = `
          <div style="min-width:0">
            <div><strong>${entry.tier}</strong></div>
            <div class="gmSmall gmMono">${entry.items.join(" · ")}</div>
          </div>
          <div class="gmSmall">${new Date(entry.at).toLocaleString()}</div>
        `;
        el.appendChild(div);
      });
    }

    function renderPosts(){
      const el = $("#postList");
      if(!el) return;
      el.innerHTML = "";
      if(!posts.length){
        el.innerHTML = `<div class="gmItem"><div class="gmSmall">No posts yet.</div></div>`;
        return;
      }
      posts.slice().reverse().forEach((p, idxFromEnd)=>{
        const idx = posts.length - 1 - idxFromEnd;
        const div = document.createElement("div");
        div.className = "gmItem";
        div.innerHTML = `
          <div style="min-width:0">
            <div><strong>${p.type}</strong> — ${p.title || "Untitled"}</div>
            <div class="gmSmall">${p.body || ""}</div>
            <div class="gmSmall" style="margin-top:6px;">${new Date(p.at).toLocaleString()}</div>
          </div>
          <div>
            <button type="button" data-post-del="${idx}" class="gmBtn danger">Delete</button>
          </div>
        `;
        el.appendChild(div);
      });
    }

    function setCharInputsFromState(){
      $("#cName").value = charState.name || "";
      $("#cAncestry").value = charState.ancestry || "";
      $("#cClass").value = charState.klass || "";
      $("#cBackground").value = charState.background || "";
      $("#cKey").value = charState.key || "";
      $("#cAC").value = charState.ac || "";
      $("#cPer").value = charState.per || "";
      $("#cSaves").value = charState.saves || "";
      $("#cSkills").value = charState.skills || "";
      $("#cSigMove").value = charState.sigMove || "";
    }

    function updateCharStateFromInputs(){
      charState = {
        name: $("#cName").value.trim(),
        ancestry: $("#cAncestry").value.trim(),
        klass: $("#cClass").value.trim(),
        background: $("#cBackground").value.trim(),
        key: $("#cKey").value.trim(),
        ac: $("#cAC").value.trim(),
        per: $("#cPer").value.trim(),
        saves: $("#cSaves").value.trim(),
        skills: $("#cSkills").value.trim(),
        sigMove: $("#cSigMove").value.trim(),
      };
      store.set(CHAR_KEY, charState);
    }

    function buildShareLink(){
      const data = JSON.stringify(charState);
      const b64 = btoa(unescape(encodeURIComponent(data)));
      const url = new URL(window.location.href);
      url.hash = "char=" + b64;
      return url.toString();
    }

    function tryLoadCharFromHash(){
      const hash = window.location.hash || "";
      if(!hash.startsWith("#char=")) return false;
      const b64 = hash.slice(6);
      try{
        const json = decodeURIComponent(escape(atob(b64)));
        const obj = JSON.parse(json);
        if(obj && typeof obj === "object"){
          charState = {...charState, ...obj};
          store.set(CHAR_KEY, charState);
          setCharInputsFromState();
          aerinSay("I see them.\nThe shape holds.");
          return true;
        }
      }catch{}
      return false;
    }

    /* ---------------------------
       GM Actions (Aerin voice)
    ----------------------------*/
    function gmRoll(expr){
      const parsed = parseDiceExpr(expr);
      const r = rollDice(parsed);
      const details = formatRollDetails(r);

      rollLog.push({ expr: parsed.canonical, total: r.total, details, at: nowISO() });
      if(rollLog.length > 60) rollLog = rollLog.slice(-60);
      store.set(ROLL_KEY, rollLog);
      renderRollLog();

      const tone =
        r.total >= 30 ? "The air tilts. A clean edge.\n" :
        r.total <= 5 ? "The dice sound like small failures.\n" :
        "";

      aerinSay(`${tone}${parsed.canonical}.\nTotal: ${r.total}.\n${details}`);
      return r.total;
    }

    function gmCondAdjust(name, delta){
      const cur = conditions[name] || 0;
      const next = clamp(cur + delta, 0, 10);
      conditions[name] = next;
      store.set(COND_KEY, conditions);
      renderConditions();
      aerinSay(`${name} ${next}.\nIt shifts. Not much. Enough.`);
    }

    function gmCondClear(){
      conditions = {};
      store.set(COND_KEY, conditions);
      renderConditions();
      aerinSay("The weight comes off.\nConditions cleared.");
    }

    function addCombatant(name, init){
      name = String(name || "").trim().replace(/^"|"$/g,"");
      if(!name) throw new Error("Name required.");
      const nInit = parseInt(init,10);
      if(Number.isNaN(nInit)) throw new Error("Initiative must be a number.");
      encounter.combatants.push({ name, init: nInit });
      renderEncounter();
      aerinSay(`${name} enters the line.\nInitiative: ${nInit}.`);
    }

    function nextTurn(){
      if(encounter.combatants.length === 0) return;
      encounter.turnIndex += 1;
      if(encounter.turnIndex >= encounter.combatants.length){
        encounter.turnIndex = 0;
        encounter.round = Math.max(1, encounter.round + 1);
      }
      renderEncounter();
      const cur = encounter.combatants[encounter.turnIndex];
      aerinSay(`Round ${encounter.round}.\n${cur?.name || "—"} now.`);
    }

    function prevTurn(){
      if(encounter.combatants.length === 0) return;
      encounter.turnIndex -= 1;
      if(encounter.turnIndex < 0){
        encounter.turnIndex = encounter.combatants.length - 1;
        encounter.round = Math.max(1, encounter.round - 1);
      }
      renderEncounter();
      const cur = encounter.combatants[encounter.turnIndex];
      aerinSay(`Back one step.\n${cur?.name || "—"} now.`);
    }

    function resetEncounter(){
      encounter = { round: 1, turnIndex: 0, combatants: [] };
      store.set(ENCOUNTER_KEY, encounter);
      renderEncounter();
      aerinSay("The field is empty again.\nReset.");
    }

    function generateLoot(tier){
      const t = lootTables[tier] || lootTables.standard;
      const items = [];

      if(tier === "street"){
        items.push(`Coins: ${rollInlineDice(rollFromTable(t.coins))}`);
        items.push(`Trinket: ${rollFromTable(t.trinket)}`);
        if(Math.random() < .55) items.push(`Oddity: ${rollFromTable(t.oddity)}`);
        if(Math.random() < .60) items.push(`Consumable: ${rollFromTable(t.consumable)}`);
      }else if(tier === "hoard"){
        items.push(`Coins: ${rollInlineDice(rollFromTable(t.coins))}`);
        items.push(`Treasure: ${rollFromTable(t.treasure)}`);
        items.push(`Consumable: ${rollFromTable(t.consumable)}`);
        if(Math.random() < .75) items.push(`Hook: ${rollFromTable(t.hook)}`);
        if(Math.random() < .55) items.push(`Bonus: ${rollFromTable(t.consumable)}`);
      }else{
        items.push(`Coins: ${rollInlineDice(rollFromTable(t.coins))}`);
        items.push(`Consumable: ${rollFromTable(t.consumable)}`);
        if(Math.random() < .65) items.push(`Gear: ${rollFromTable(t.gear)}`);
        if(Math.random() < .55) items.push(`Oddity: ${rollFromTable(t.oddity)}`);
      }

      lootLog.push({ tier, items, at: nowISO() });
      if(lootLog.length > 30) lootLog = lootLog.slice(-30);
      store.set(LOOT_KEY, lootLog);
      renderLoot();

      aerinSay(`I check the pockets.\n${items.join("\n")}`);
    }

    function addPost(type, title, body){
      if(!title && !body) throw new Error("Post needs a title or body.");
      posts.push({ type, title, body, at: nowISO() });
      if(posts.length > 60) posts = posts.slice(-60);
      store.set(POST_KEY, posts);
      renderPosts();
      aerinSay(`Pinned to the board.\n${type}: ${title || "Untitled"}`);
    }

    /* ---------------------------
       Slash commands
    ----------------------------*/
    function runGMCommand(cmd){
      const raw = String(cmd || "").trim();
      const parts = raw.split(" ");
      const head = (parts[0] || "").toLowerCase();
      const rest = parts.slice(1);

      if(head === "help"){
        aerinSay("Tools are here.\nUse /roll, /cond, /loot, /encounter.\nIf you want a picture: /vision.");
        return;
      }

      if(head === "roll"){
        gmRoll(rest.join(" ").trim());
        return;
      }

      if(head === "cond" || head === "condition"){
        const sub = (rest[0] || "").toLowerCase();
        if(sub === "clear"){ gmCondClear(); return; }
        const maybeVal = rest[rest.length-1];
        const val = parseInt(maybeVal,10);
        if(Number.isNaN(val)) throw new Error("Use: /cond frightened 2");
        const name = rest.slice(0,-1).join(" ").trim();
        if(!name) throw new Error("Condition name required.");
        const pretty = name.split(":").map(s=>s.trim()).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(": ");
        conditions[pretty] = clamp(val, 0, 10);
        store.set(COND_KEY, conditions);
        renderConditions();
        aerinSay(`${pretty} ${conditions[pretty]}.\nNoted.`);
        return;
      }

      if(head === "loot"){
        const tier = (rest[0] || "standard").toLowerCase();
        if(!lootTables[tier]) throw new Error("Loot tier: street | standard | hoard");
        generateLoot(tier);
        return;
      }

      if(head === "encounter"){
        const sub = (rest[0] || "").toLowerCase();
        if(sub === "add"){
          const maybeVal = rest[rest.length-1];
          const init = parseInt(maybeVal,10);
          if(Number.isNaN(init)) throw new Error('Use: /encounter add "Goblin" 18');
          const name = rest.slice(1,-1).join(" ").trim();
          addCombatant(name, init);
          return;
        }
        if(sub === "next"){ nextTurn(); return; }
        if(sub === "prev"){ prevTurn(); return; }
        if(sub === "reset"){ resetEncounter(); return; }
        throw new Error("Use: /encounter add|next|prev|reset");
      }

      if(head === "vision" || head === "omen"){
        const prompt = rest.join(" ").trim();
        if(!prompt) throw new Error("Use: /vision candlelit cairn door, blue light, runes");
        const stitched = `${AERIN_BASE_VISION_TEXT}\nUser prompt: ${prompt}\nStyle: ${AERIN_VISION_STYLE}`;
        generateVision(stitched, {reroll:true, talk:true});
        return;
      }

      throw new Error("Unknown command. Try /help");
    }

    function maybeHandleSlashCommand(text){
      const t = String(text || "").trim();
      if(!t.startsWith("/")) return false;

      messages.push({ role: "user", content: t });
      render();

      const cmd = t.slice(1).trim();
      try{
        runGMCommand(cmd);
      }catch(e){
        aerinSay(`No.\n${e.message}`);
      }
      setStatus("Ready");
      return true;
    }

    /* ---------------------------
       Page events (Chat)
    ----------------------------*/
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      if(maybeHandleSlashCommand(text)){
        input.value = "";
        input.focus();
        return;
      }

      sendBtn.disabled = true;
      input.disabled = true;
      input.value = "";

      try {
        await sendMessage(text);
      } catch (err) {
        showError(err.message || String(err));
        setStatus("Error");
      } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    });

    /* ---------------------------
       Init Toolkit
    ----------------------------*/
    function initToolkit(){
      tryLoadCharFromHash();
      setCharInputsFromState();

      renderRollLog();
      renderConditions();
      renderEncounter();
      renderLoot();
      renderPosts();

      initVisionUI();

      $("#rollBtn").addEventListener("click", ()=>{
        try{ gmRoll($("#diceExpr").value); }
        catch(e){ aerinSay(`No.\n${e.message}`); }
      });
      $("#diceExpr").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); $("#rollBtn").click(); }
      });
      $("#clearRollsBtn").addEventListener("click", ()=>{
        rollLog = [];
        store.set(ROLL_KEY, rollLog);
        renderRollLog();
        aerinSay("The record fades.\nRoll log cleared.");
      });

      $("#condPlus").addEventListener("click", ()=> gmCondAdjust($("#condSelect").value, +1));
      $("#condMinus").addEventListener("click", ()=> gmCondAdjust($("#condSelect").value, -1));
      $("#condClear").addEventListener("click", gmCondClear);

      $("#addInitBtn").addEventListener("click", ()=>{
        try{
          addCombatant($("#initName").value, $("#initValue").value);
          $("#initName").value = "";
          $("#initValue").value = "";
        }catch(e){ aerinSay(`No.\n${e.message}`); }
      });

      $("#rollInitBtn").addEventListener("click", ()=>{
        const name = $("#initName").value.trim();
        if(!name){ aerinSay("Name first.\nThen we roll."); return; }
        const modStr = ($("#initMod").value || "").trim().replace(/\s/g,"");
        let mod = 0;
        if(modStr){
          if(!/^[+-]?\d+$/.test(modStr)){ aerinSay("Use +7.\nOr -1.\nKeep it clean."); return; }
          mod = parseInt(modStr,10);
        }
        const init = rollDie(20) + mod;
        addCombatant(name, init);
        $("#initName").value = "";
      });

      $("#nextTurnBtn").addEventListener("click", nextTurn);
      $("#prevTurnBtn").addEventListener("click", prevTurn);
      $("#resetEncounterBtn").addEventListener("click", resetEncounter);

      $("#initList").addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(!btn) return;
        const act = btn.getAttribute("data-act");
        const idx = parseInt(btn.getAttribute("data-idx"),10);
        if(Number.isNaN(idx)) return;

        if(act === "set"){
          encounter.turnIndex = idx;
          renderEncounter();
          const cur = encounter.combatants[encounter.turnIndex];
          aerinSay(`We align on them.\n${cur?.name || "—"} now.`);
        }else if(act === "del"){
          const name = encounter.combatants[idx]?.name || "";
          encounter.combatants.splice(idx, 1);
          encounter.turnIndex = clamp(encounter.turnIndex, 0, Math.max(0, encounter.combatants.length-1));
          renderEncounter();
          aerinSay(`${name} steps out.\nGone.`);
        }
      });

      $("#genLootBtn").addEventListener("click", ()=> generateLoot($("#lootTier").value));
      $("#clearLootBtn").addEventListener("click", ()=>{
        lootLog = [];
        store.set(LOOT_KEY, lootLog);
        renderLoot();
        aerinSay("No coins.\nNo scraps.\nClean slate.");
      });

      $("#updateCardBtn").addEventListener("click", ()=>{
        updateCharStateFromInputs();
        aerinSay("I hold the details.\nThey won’t slip.");
      });

      $("#copyShareBtn").addEventListener("click", async ()=>{
        updateCharStateFromInputs();
        const link = buildShareLink();
        try{
          await navigator.clipboard.writeText(link);
          aerinSay("Link copied.\nCarry it where you need it.");
        }catch{
          prompt("Copy this link:", link);
        }
      });

      $("#clearCardBtn").addEventListener("click", ()=>{
        charState = { name:"", ancestry:"", klass:"", background:"", key:"", ac:"", per:"", saves:"", skills:"", sigMove:"" };
        store.set(CHAR_KEY, charState);
        setCharInputsFromState();
        aerinSay("Blank again.\nA quiet page.");
      });

      $("#addPostBtn").addEventListener("click", ()=>{
        try{
          addPost($("#postType").value, $("#postTitle").value.trim(), $("#postBody").value.trim());
          $("#postTitle").value = "";
          $("#postBody").value = "";
        }catch(e){ aerinSay(`No.\n${e.message}`); }
      });

      $("#clearPostsBtn").addEventListener("click", ()=>{
        posts = [];
        store.set(POST_KEY, posts);
        renderPosts();
        aerinSay("The board is bare.\nNo voices.\nFor now.");
      });

      $("#postList").addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(!btn) return;
        const idx = parseInt(btn.getAttribute("data-post-del"),10);
        if(Number.isNaN(idx)) return;
        posts.splice(idx,1);
        store.set(POST_KEY, posts);
        renderPosts();
        aerinSay("One note removed.\nThe wall breathes.");
      });
    }

    // Boot
    render();
    initToolkit();
  </script>
</body>
</html>
